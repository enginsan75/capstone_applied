
DELETE FROM db_2019_2022.dt_maib_son 
WHERE YIL='2022';


CREATE TABLE db_2019_2022.dt_maib_son_2019_2021
SELECT * FROM db_2019_2022.dt_maib_son 
WHERE YIL<2022;

DROP TABLE db_2019_2022.new2022;
CREATE TABLE db_2019_2022.new2022 (IHRITH varchar(20), YIL int(12), 
AY int(12), ISTPOZ char(50), ULKE_ADI varchar(250), ULKE_GRUBU varchar(250),
ULKE_GRUP_ADI varchar(250),SUM_OF_DOLAR bigint, SUM_OF_MIKTAR_1 bigint)


DROP TABLE db_2019_2022.dbnew;
CREATE TABLE db_2019_2022.dbnew AS
SELECT A.*, B.* 
FROM db_2019_2022.new2022 A LEFT JOIN db_2019_2022.segment2022 B ON A.ISTPOZ =B.KOD;

DROP TABLE db_2019_2022.dbnew1;
CREATE TABLE db_2019_2022.dbnew1 AS
SELECT E.*, F.* 
FROM db_2019_2022.dbnew E, db_2019_2022.ulkeref F 
WHERE E.ULKE_KOD=F.ulke;

DROP TABLE db_2019_2022.dbnew2;
CREATE TABLE db_2019_2022.dbnew2 AS
SELECT DISTINCTROW * FROM db_2019_2022.dbnew1 d ;

INSERT INTO db_2019_2022.dt_maib_son_2019_2021
(IHRITH, YIL, AY, ISTPOZ, SUM_OF_DOLAR, SUM_OF_MIKTAR_1, KOD, SEGMENT, ulkegrup_kod, ulke, ulke_adi, ulke_grup_adi, maib_grup1, maib_grup2)
SELECT * FROM db_2019_2022.dbnew2
ORDER BY YIL;
 
DROP TABLE db_2019_2022.report_segment;
CREATE TABLE db_2019_2022.report_segment AS
SELECT report.SEGMENT,
SUM(CASE WHEN report.YIL='2021' AND report.IHRITH='H' THEN report.DEĞER
else 0
end) as 2021_IHR_DEGER,
SUM(CASE WHEN report.YIL='2021' AND report.IHRITH='T' THEN report.DEĞER
else 0
end) as 2021_ITH_DEGER,
SUM(CASE WHEN report.YIL='2022' AND report.IHRITH='H' THEN report.DEĞER
else 0
end) as 2022_IHR_DEGER,
SUM(CASE WHEN report.YIL='2022' AND report.IHRITH='T' THEN report.DEĞER
else 0
end) as 2022_ITH_DEGER
FROM(SELECT SEGMENT, YIL, IHRITH, ROUND(SUM_OF_DOLAR/1000000,1) AS "DEĞER" FROM db_2019_2022.dt_maib_son_revize  
WHERE YIL IN ('2021', '2022')
AND AY BETWEEN 1 AND 9 AND KOD IS NOT NULL) report
GROUP BY SEGMENT;

DROP TABLE db_2019_2022.report_segment;
CREATE TABLE db_2019_2022.report_segment AS
SELECT *,
SUM(CASE WHEN a.YIL1='2021' AND a.IHRITH1='H' THEN a.DEĞER1
else 0
end) as 2021_IHR_DEGER,
SUM(CASE WHEN b.YIL2='2021' AND b.IHRITH2='T' THEN b.DEĞER2
else 0
end) as 2021_ITH_DEGER,
SUM(CASE WHEN c.YIL3='2022' AND c.IHRITH3='H' THEN c.DEĞER3
else 0
end) as 2022_IHR_DEGER,
SUM(CASE WHEN d.YIL4='2022' AND d.IHRITH4='T' THEN d.DEĞER4
else 0
end) as 2022_ITH_DEGER
FROM(SELECT SEGMENT AS SEGMENT1, YIL AS YIL1, AY AS AY1, IHRITH AS IHRITH1, SUM(SUM_OF_DOLAR/1000000) AS "DEĞER1" FROM db_2019_2022.dt_maib_son_revize dmsr  WHERE YIL='2021' 
AND IHRITH ='H' AND AY BETWEEN 1 AND 9 AND KOD IS NOT NULL
GROUP BY SEGMENT) a,
(SELECT SEGMENT AS SEGMENT2, YIL AS YIL2, AY AS AY2, IHRITH AS IHRITH2, SUM(SUM_OF_DOLAR/1000000) AS "DEĞER2" FROM db_2019_2022.dt_maib_son_revize dmsr  WHERE YIL='2021' 
AND IHRITH ='T' AND AY BETWEEN 1 AND 9 AND KOD IS NOT NULL
GROUP BY SEGMENT) b,
(SELECT SEGMENT AS SEGMENT3, YIL AS YIL3, AY AS AY3, IHRITH AS IHRITH3, SUM(SUM_OF_DOLAR/1000000) AS "DEĞER3" FROM db_2019_2022.dt_maib_son_revize dmsr  WHERE YIL='2022' 
AND IHRITH ='H' AND AY BETWEEN 1 AND 9 AND KOD IS NOT NULL
GROUP BY SEGMENT) c,
(SELECT SEGMENT AS SEGMENT4, YIL AS YIL4, AY AS AY4, IHRITH AS IHRITH4, SUM(SUM_OF_DOLAR/1000000) AS "DEĞER4" FROM db_2019_2022.dt_maib_son_revize dmsr  WHERE YIL='2022' 
AND IHRITH ='T' AND AY BETWEEN 1 AND 9 AND KOD IS NOT NULL
GROUP BY SEGMENT) d;




SELECT SEGMENT, SUM(SUM_OF_DOLAR/1000000) AS "DEĞER" FROM db_2019_2022.dt_maib_son_revize dmsr  WHERE YIL='2022' 
AND IHRITH ='H' AND AY BETWEEN 1 AND 9 AND KOD IS NOT NULL
GROUP BY SEGMENT;

SELECT SEGMENT, SUM(SUM_OF_DOLAR/1000000) AS "DEĞER" FROM db_2019_2022.dt_maib_son_revize dmsr  WHERE YIL='2021' 
AND IHRITH ='H' AND AY BETWEEN 1 AND 9 AND KOD IS NOT NULL
GROUP BY SEGMENT;


DROP TABLE db_2019_2022.report_ulke_ihracat;
CREATE TABLE db_2019_2022.report_ulke_ihracat AS
SELECT s.ulke_adi, s.DEĞER AS 2021_DEĞER, p.DEĞER AS 2022_DEĞER
FROM (SELECT ulke_adi, SUM(SUM_OF_DOLAR/1000000) AS "DEĞER" FROM db_2019_2022.dt_maib_son_revize WHERE YIL='2021' 
AND IHRITH ='H' AND AY BETWEEN 1 AND 9 AND KOD IS NOT NULL
GROUP BY ulke_adi 
ORDER BY SUM(SUM_OF_DOLAR) DESC
LIMIT 10) s,
(SELECT ulke_adi AS ulke_adi2, SUM(SUM_OF_DOLAR/1000000) AS "DEĞER" FROM db_2019_2022.dt_maib_son_revize 
WHERE YIL='2022' 
AND IHRITH ='H' AND AY BETWEEN 1 AND 9 AND KOD IS NOT NULL 
GROUP BY ulke_adi
ORDER BY SUM(SUM_OF_DOLAR) DESC
LIMIT 10) p
WHERE s.ulke_adi=p.ulke_adi2;



DROP TABLE db_2019_2022.report_ulke_ithalat;
CREATE TABLE db_2019_2022.report_ulke_ithalat AS
SELECT s.ulke_adi, s.DEĞER AS 2021_DEĞER, p.DEĞER AS 2022_DEĞER
FROM (SELECT ulke_adi, SUM(SUM_OF_DOLAR/1000000) AS "DEĞER" FROM db_2019_2022.dt_maib_son_revize WHERE YIL='2021' 
AND IHRITH ='T' AND AY BETWEEN 1 AND 9 AND KOD IS NOT NULL
GROUP BY ulke_adi 
ORDER BY SUM(SUM_OF_DOLAR) DESC
LIMIT 10) s,
(SELECT ulke_adi AS ulke_adi2, SUM(SUM_OF_DOLAR/1000000) AS "DEĞER" FROM db_2019_2022.dt_maib_son_revize
WHERE YIL='2022' 
AND IHRITH ='T' AND AY BETWEEN 1 AND 9 AND KOD IS NOT NULL 
GROUP BY ulke_adi
ORDER BY SUM(SUM_OF_DOLAR) DESC
LIMIT 10) p
WHERE s.ulke_adi=p.ulke_adi2;


SELECT maib_grup2, SUM(SUM_OF_DOLAR) FROM db_2019_2022.dt_maib_son_revize dmsr 
WHERE YIL='2022' AND IHRITH='H' AND KOD IS NOT NULL
GROUP BY maib_grup2 ; 

SELECT maib_grup1, SUM(SUM_OF_DOLAR) FROM db_2019_2022.dt_maib_son_revize dmsr 
WHERE YIL='2022' AND IHRITH='H' AND KOD IS NOT NULL
GROUP BY maib_grup1 ; 





